<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="/images/favicon.png" />

<title>You could have invented it yourself: Dependency Injection&nbsp;|&nbsp;Dr. Michael Lesniak -- Turning Code Into Business Value</title>
<meta
  name="title"
  content="You could have invented it yourself: Dependency Injection"
/>
<meta
  name="description"
  content="Why do we need Dependency Injection? Dependency Injection (DI) addresses a simple but critical problem: keeping your code manageable. Without it, you’re stuck with tightly coupled components, like a Car class that directly creates its own Engine.
Initially, this seems fine. But what happens when you need different engines, gas, electric, or something new? Suddenly, your Car class has to handle creation logic, breaking its focus and making changes a nightmare."
/>
<meta
  name="keywords"
  content=""
/>

  <meta name="author" content="Dr. Michael Lesniak" />




<meta property="og:url" content="https://example.com/articles/di/">
  <meta property="og:site_name" content="Dr. Michael Lesniak -- Turning Code Into Business Value">
  <meta property="og:title" content="You could have invented it yourself: Dependency Injection">
  <meta property="og:description" content="Why do we need Dependency Injection? Dependency Injection (DI) addresses a simple but critical problem: keeping your code manageable. Without it, you’re stuck with tightly coupled components, like a Car class that directly creates its own Engine.
Initially, this seems fine. But what happens when you need different engines, gas, electric, or something new? Suddenly, your Car class has to handle creation logic, breaking its focus and making changes a nightmare.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="articles">
    <meta property="article:published_time" content="2025-01-03T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-01-03T00:00:00+00:00">





  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="You could have invented it yourself: Dependency Injection">
  <meta name="twitter:description" content="Why do we need Dependency Injection? Dependency Injection (DI) addresses a simple but critical problem: keeping your code manageable. Without it, you’re stuck with tightly coupled components, like a Car class that directly creates its own Engine.
Initially, this seems fine. But what happens when you need different engines, gas, electric, or something new? Suddenly, your Car class has to handle creation logic, breaking its focus and making changes a nightmare.">





  <meta itemprop="name" content="You could have invented it yourself: Dependency Injection">
  <meta itemprop="description" content="Why do we need Dependency Injection? Dependency Injection (DI) addresses a simple but critical problem: keeping your code manageable. Without it, you’re stuck with tightly coupled components, like a Car class that directly creates its own Engine.
Initially, this seems fine. But what happens when you need different engines, gas, electric, or something new? Suddenly, your Car class has to handle creation logic, breaking its focus and making changes a nightmare.">
  <meta itemprop="datePublished" content="2025-01-03T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-01-03T00:00:00+00:00">
  <meta itemprop="wordCount" content="1768">
<meta name="referrer" content="no-referrer-when-downgrade" />

    
    <link href="/simple.min.css" rel="stylesheet" />

    
    <link href="/style.min.css" rel="stylesheet" />

    

    










<link rel="stylesheet" href="/custom.css" />

</head>

  <body>
    <header>
      <nav>
  <a
    href="/"
    
    >Home</a
  >

  <a
    href="/articles/"
    
    >Articles</a
  >

  <a
    href="/journey/"
    
    >My Journey</a
  >

  <a
    href="/resume/"
    
    >Resume</a
  >

  <a
    href="/contact"
    
    >Contact &amp; Legal Notice</a
  >


</nav>

<h1>You could have invented it yourself: Dependency Injection</h1>


    </header>
    <main>
      
  
  
  <content>
    <h2 id="why-do-we-need-dependency-injection">Why do we need Dependency Injection?</h2>
<p>Dependency Injection (DI) addresses a simple but critical problem: keeping your
code manageable. Without it, you’re stuck with tightly coupled components, like
a Car class that directly creates its own Engine.</p>
<p>Initially, this seems fine. But what happens when you need different engines,
gas, electric, or something new? Suddenly, your Car class has to handle creation
logic, breaking its focus and making changes a nightmare.</p>
<p>DI changes the approach. Instead of creating its own dependencies, the Car
gets its
Engine from the outside. This keeps your code focused, flexible, and easy to
test. Swap an engine? Update a configuration? No problem.</p>
<p>You don’t need a fancy framework to do DI. But frameworks like Spring automate
the wiring, saving time. The payoff? Cleaner code, fewer headaches, and a
codebase that doesn’t fight you every time something changes.</p>
<p>From the outside, it might seem like magic. Here&rsquo;s how you can implement it yourself.</p>
<h2 id="the-canonical-spring-example">The canonical Spring example</h2>
<p>The simplest example consists of a (Spring) component <code>MessageConsumer</code> which
depends on another (Spring) component <code>MessageProvider</code>, which in turn does not
have any further dependencies. When starting the application, the <code>run</code>
method from the consumer is called since it implements <code>CommandLineRunner</code>:</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span><span style="color:#999;font-style:italic">// Main.java</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">org.springframework.boot.SpringApplication</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">org.springframework.boot.autoconfigure.SpringBootApplication</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span><span style="color:#666"></span><span style="color:#ffa500">@SpringBootApplication</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">Main</span><span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">static</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">void</span><span style="color:#666"> </span><span style="color:#447fcf">main</span>(String...<span style="color:#666"> </span>args)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span><span style="color:#666">        </span>SpringApplication.<span style="color:#bbb">run</span>(Main.<span style="color:#bbb">class</span>,<span style="color:#666"> </span>args);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span><span style="color:#666">    </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span><span style="color:#666"></span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">// MessageConsumer.java</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">org.springframework.boot.CommandLineRunner</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">org.springframework.stereotype.Component</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span><span style="color:#666"></span><span style="color:#ffa500">@Component</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">MessageConsumer</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">implements</span><span style="color:#666"> </span>CommandLineRunner<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">private</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">final</span><span style="color:#666"> </span>MessageProvider<span style="color:#666"> </span>messageProvider;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#447fcf">MessageConsumer</span>(MessageProvider<span style="color:#666"> </span>messageProvider)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">this</span>.<span style="color:#bbb">messageProvider</span><span style="color:#666"> </span>=<span style="color:#666"> </span>messageProvider;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span><span style="color:#666">    </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span><span><span style="color:#666">    </span><span style="color:#ffa500">@Override</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">void</span><span style="color:#666"> </span><span style="color:#447fcf">run</span>(String...<span style="color:#666"> </span>args)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span><span><span style="color:#666">        </span>String<span style="color:#666"> </span>message<span style="color:#666"> </span>=<span style="color:#666"> </span>messageProvider.<span style="color:#bbb">getMessage</span>();<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28</span><span><span style="color:#666">        </span>System.<span style="color:#bbb">out</span>.<span style="color:#bbb">println</span>(message);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">29</span><span><span style="color:#666">    </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">30</span><span><span style="color:#666"></span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">31</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">32</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">33</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">// MessageProvider.java</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">34</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">org.springframework.stereotype.Component</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">35</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">36</span><span><span style="color:#666"></span><span style="color:#ffa500">@Component</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">37</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">MessageProvider</span><span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">38</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span>String<span style="color:#666"> </span><span style="color:#447fcf">getMessage</span>()<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">39</span><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span><span style="color:#ed9d13">&#34;Hello, world&#34;</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">40</span><span><span style="color:#666">    </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">41</span><span><span style="color:#666"></span>}</span></span></code></pre></div>
<p>In the following sections, we will implement our own dependency injection
framework. Our goal is to allow seamless switching of import statements to our implementation without any other changes.
The example should still function as expected.</p>
<h2 id="our-own-implementation">Our own implementation</h2>
<p>Spring&rsquo;s DI framework offers extensive functionality, much of which is beyond the scope of this educational example.
Let’s begin by clarifying what we won’t implement, though much of it is
straightforward:</p>
<ul>
<li>Lifecycle Management. No support for <code>@PostConstruct</code>, <code>@PreDestroy</code>, &hellip;</li>
<li>Scope Management. We only support singletons. Adding additional types such
as Request, Prototype, Session would be possible by adding a dedicated
<code>ApplicationContext</code> and appropriate methods. Since we do not support
<code>@Controller</code> in our small example, these do not make sense anyway.</li>
<li>No Aspect-oriented programming (AOP). This might be a bit more tricky and
will probably be covered in a future post.</li>
<li>No field or method injection. Technically, trivial to implement, but would
just blow up the code without providing additional insights.</li>
</ul>
<p>&hellip; and, as always, we implement minimal error and edge case handling &ndash;
definitely not production-ready. ;-)</p>
<p>Having said all that, let&rsquo;s start with modifications to our <code>Main</code> class.
Since the name <code>SpringApplication</code> is already reserved, and summer follows on
spring, let&rsquo;s call it &hellip; <code>SummerApplication</code>:</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">com.mlesniak.boot.SummerApplication</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">Main</span><span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">static</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">void</span><span style="color:#666"> </span><span style="color:#447fcf">main</span>(String...<span style="color:#666"> </span>args)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5</span><span><span style="color:#666">        </span>SummerApplication.<span style="color:#bbb">run</span>(Main.<span style="color:#bbb">class</span>,<span style="color:#666"> </span>args);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6</span><span><span style="color:#666">    </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7</span><span><span style="color:#666"></span>}</span></span></code></pre></div>
<p>The remaining files stay the same, though, as promised, we change the imports:</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span><span style="color:#999;font-style:italic">// MessageProvider.java</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">com.mlesniak.boot.Component</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span><span style="color:#666"></span><span style="color:#ffa500">@Component</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">MessageProvider</span><span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span>String<span style="color:#666"> </span><span style="color:#447fcf">getMessage</span>()<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span><span style="color:#ed9d13">&#34;Hello, world&#34;</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span><span style="color:#666">    </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span><span style="color:#666"></span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">// MessageConsumer.java</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">com.mlesniak.boot.CommandLineRunner</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">com.mlesniak.boot.Component</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span><span style="color:#666"></span><span style="color:#ffa500">@Component</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">MessageConsumer</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">implements</span><span style="color:#666"> </span>CommandLineRunner<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">private</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">final</span><span style="color:#666"> </span>MessageProvider<span style="color:#666"> </span>messageProvider;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#447fcf">MessageConsumer</span>(MessageProvider<span style="color:#666"> </span>messageProvider)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">this</span>.<span style="color:#bbb">messageProvider</span><span style="color:#666"> </span>=<span style="color:#666"> </span>messageProvider;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span><span style="color:#666">  </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span><span style="color:#666">  </span><span style="color:#ffa500">@Override</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">void</span><span style="color:#666"> </span><span style="color:#447fcf">run</span>(String...<span style="color:#666"> </span>args)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span><span><span style="color:#666">    </span>String<span style="color:#666"> </span>message<span style="color:#666"> </span>=<span style="color:#666"> </span>messageProvider.<span style="color:#bbb">getMessage</span>();<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span><span><span style="color:#666">    </span>System.<span style="color:#bbb">out</span>.<span style="color:#bbb">println</span>(message);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span><span><span style="color:#666">  </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28</span><span><span style="color:#666"></span>}</span></span></code></pre></div>
<h3 id="marking-things">Marking things&hellip;</h3>
<p>Since we do not use Controllers but still want an entrypoint, let&rsquo;s define our
own marker interface:</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span><span style="color:#6ab825;font-weight:bold">package</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">com.mlesniak.boot</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">/// Marker interface to determine where our application</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">/// starts since we do not have typical controllers</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">/// waiting for HTTP requests.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">interface</span> <span style="color:#447fcf;text-decoration:underline">CommandLineRunner</span><span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">void</span><span style="color:#666"> </span><span style="color:#447fcf">run</span>(String...<span style="color:#666"> </span>args);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">8</span><span><span style="color:#666"></span>}</span></span></code></pre></div>
<p>We also want to annotate service classes with our own Component annotation</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span><span style="color:#6ab825;font-weight:bold">package</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">com.mlesniak.boot</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.lang.annotation.ElementType</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.lang.annotation.Retention</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.lang.annotation.RetentionPolicy</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.lang.annotation.Target</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">///</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">/// Marker interface to determine components of our application.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">///</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">/// For every class marked as a component, we try to resolve all</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">/// dependencies in its constructor.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span><span style="color:#666"></span><span style="color:#ffa500">@Retention</span>(RetentionPolicy.<span style="color:#bbb">RUNTIME</span>)<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span><span style="color:#666"></span><span style="color:#ffa500">@Target</span>(ElementType.<span style="color:#bbb">TYPE</span>)<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#ffa500">@interface</span><span style="color:#666"> </span>Component<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span><span style="color:#666"></span>}</span></span></code></pre></div>
<h3 id="the-interesting-part">The interesting part</h3>
<p>The actual magic is implemented in the following 140 lines of code. We walk
through them step by step.</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span><span style="color:#6ab825;font-weight:bold">package</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">com.mlesniak.boot</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">com.mlesniak.Main</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.io.IOException</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.lang.reflect.InvocationTargetException</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.net.URI</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.net.URISyntaxException</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.nio.file.*</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.util.*</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">import</span><span style="color:#666"> </span><span style="color:#447fcf;text-decoration:underline">java.util.stream.Collectors</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span><span style="color:#666"></span><span style="color:#999;font-style:italic">/// Core dependency injection resolution.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">SummerApplication</span><span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">// ... to be filled out in this section ...</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span><span style="color:#666"></span>}</span></span></code></pre></div>
<p>Our sole public method is <code>run</code>, which serves to purposes:</p>
<ol>
<li>Create all necessary singletons</li>
<li>Figure out the component implementing <code>CommandLineRunner</code> and start them.</li>
</ol>
<p>Therefore, the code is straightforward:</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// Entry point into dependency injection.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">///</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// @param mainClass The main class of the application, ideally placed at the root package.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// @param args      Command line args.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">public</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">static</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">void</span><span style="color:#666"> </span><span style="color:#447fcf">run</span>(Class&lt;Main&gt;<span style="color:#666"> </span>mainClass,<span style="color:#666"> </span>String[]<span style="color:#666"> </span>args)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span><span style="color:#666">      </span>List&lt;Class&lt;?&gt;&gt;<span style="color:#666"> </span>components<span style="color:#666"> </span>=<span style="color:#666"> </span>getComponents(mainClass);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span><span style="color:#666">      </span><span style="color:#999;font-style:italic">// For our example, we support only singletons.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span><span style="color:#666">      </span>Map&lt;Class&lt;?&gt;,<span style="color:#666"> </span>Object&gt;<span style="color:#666"> </span>instances<span style="color:#666"> </span>=<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">new</span><span style="color:#666"> </span>HashMap&lt;&gt;();<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span><span style="color:#666">      </span>components.<span style="color:#bbb">forEach</span>(component<span style="color:#666"> </span>-&gt;<span style="color:#666"> </span>createSingleton(instances,<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">new</span><span style="color:#666"> </span>HashSet&lt;&gt;(),<span style="color:#666"> </span>component));<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span><span style="color:#666">      </span><span style="color:#999;font-style:italic">// Find entry point by looking for the class implementing CommandLineRunner. </span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">var</span><span style="color:#666"> </span>entryClasses<span style="color:#666"> </span>=<span style="color:#666"> </span>instances<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span><span style="color:#666">              </span>.<span style="color:#bbb">keySet</span>().<span style="color:#bbb">stream</span>()<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span><span style="color:#666">              </span>.<span style="color:#bbb">filter</span>(SummerApplication::hasCommandLineRunnerInterface)<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span><span style="color:#666">              </span>.<span style="color:#bbb">toList</span>();<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">if</span><span style="color:#666"> </span>(entryClasses.<span style="color:#bbb">isEmpty</span>())<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">throw</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">new</span><span style="color:#666"> </span>IllegalStateException(<span style="color:#ed9d13">&#34;No entry point defined via CommandLineRunner&#34;</span>);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span><span style="color:#666">      </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">if</span><span style="color:#666"> </span>(entryClasses.<span style="color:#bbb">size</span>()<span style="color:#666"> </span>&gt;<span style="color:#666"> </span>1)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">throw</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">new</span><span style="color:#666"> </span>IllegalStateException(<span style="color:#ed9d13">&#34;Ambiguous entry points defined via CommandLineRunner&#34;</span>);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span><span style="color:#666">      </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">var</span><span style="color:#666"> </span>entryClass<span style="color:#666"> </span>=<span style="color:#666"> </span>entryClasses.<span style="color:#bbb">getFirst</span>();<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span><span><span style="color:#666">      </span>((CommandLineRunner)<span style="color:#666"> </span>instances.<span style="color:#bbb">get</span>(entryClass)).<span style="color:#bbb">run</span>(args);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span><span><span style="color:#666">  </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">private</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">static</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">boolean</span><span style="color:#666"> </span><span style="color:#447fcf">hasCommandLineRunnerInterface</span>(Class&lt;?&gt;<span style="color:#666"> </span>clazz)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">29</span><span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span>Arrays.<span style="color:#bbb">stream</span>(clazz.<span style="color:#bbb">getInterfaces</span>())<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">30</span><span><span style="color:#666">            </span>.<span style="color:#bbb">anyMatch</span>(i<span style="color:#666"> </span>-&gt;<span style="color:#666"> </span>i<span style="color:#666"> </span>==<span style="color:#666"> </span>CommandLineRunner.<span style="color:#bbb">class</span>);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">31</span><span><span style="color:#666">  </span>}</span></span></code></pre></div>
<p>A key function is <code>getComponents</code>. We need to collect all classes annotated
with our custom component annotation on the classpath:</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// Get a list of all components based on the passed package of the class.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">///</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// @param mainClass the root class to start scanning.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">private</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">static</span><span style="color:#666"> </span>List&lt;Class&lt;?&gt;&gt;<span style="color:#666"> </span>getComponents(Class&lt;Main&gt;<span style="color:#666"> </span>mainClass)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">try</span><span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span>findAllClassesInPackage(mainClass.<span style="color:#bbb">getPackageName</span>()).<span style="color:#bbb">stream</span>()<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span><span style="color:#666">                  </span>.<span style="color:#bbb">filter</span>(c<span style="color:#666"> </span>-&gt;<span style="color:#666"> </span>c.<span style="color:#bbb">getAnnotation</span>(Component.<span style="color:#bbb">class</span>)<span style="color:#666"> </span>!=<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">null</span>)<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span><span style="color:#666">                  </span>.<span style="color:#bbb">collect</span>(Collectors.<span style="color:#bbb">toList</span>());<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span><span style="color:#666">      </span>}<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">catch</span><span style="color:#666"> </span>(IOException<span style="color:#666"> </span>|<span style="color:#666"> </span>URISyntaxException<span style="color:#666"> </span>e)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">throw</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">new</span><span style="color:#666"> </span>IllegalStateException(<span style="color:#ed9d13">&#34;Error retrieving components, starting at &#34;</span><span style="color:#666"> </span>+<span style="color:#666"> </span>mainClass.<span style="color:#bbb">getSimpleName</span>(),<span style="color:#666"> </span>e);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span><span style="color:#666">      </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span><span style="color:#666">  </span>}</span></span></code></pre></div>
<p>This is slightly complicated since we can either run our application with an unpacked
classpath, e.g. on the command line or via an IDE, or as a packed (fat) .
jar-file.</p>
<p>Thanks to the abstraction provided by <code>java.nio</code>, this can be handled quite
elegantly:</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// Retrieve a list of all classes in a package (or its children). This method supports both unpacked</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// (target/classes) and packed (.jar) class containers.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">private</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">static</span><span style="color:#666"> </span>Set&lt;Class&lt;?&gt;&gt;<span style="color:#666"> </span>findAllClassesInPackage(String<span style="color:#666"> </span>packageName)<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">throws</span><span style="color:#666"> </span>IOException,<span style="color:#666"> </span>URISyntaxException<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span><span style="color:#666">      </span>String<span style="color:#666"> </span>path<span style="color:#666"> </span>=<span style="color:#666"> </span>packageName.<span style="color:#bbb">replace</span>(<span style="color:#ed9d13">&#39;.&#39;</span>,<span style="color:#666"> </span><span style="color:#ed9d13">&#39;/&#39;</span>);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span><span style="color:#666">      </span>URI<span style="color:#666"> </span>uri<span style="color:#666"> </span>=<span style="color:#666"> </span>SummerApplication.<span style="color:#bbb">class</span>.<span style="color:#bbb">getResource</span>(<span style="color:#ed9d13">&#34;/&#34;</span><span style="color:#666"> </span>+<span style="color:#666"> </span>path).<span style="color:#bbb">toURI</span>();<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">if</span><span style="color:#666"> </span>(uri.<span style="color:#bbb">getScheme</span>().<span style="color:#bbb">equals</span>(<span style="color:#ed9d13">&#34;jar&#34;</span>))<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span><span style="color:#666">          </span><span style="color:#999;font-style:italic">// We have to create a &#34;virtual&#34; filesystem to access the class files stored in the</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span><span style="color:#666">          </span><span style="color:#999;font-style:italic">// .jar file.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">try</span><span style="color:#666"> </span>(FileSystem<span style="color:#666"> </span>fileSystem<span style="color:#666"> </span>=<span style="color:#666"> </span>FileSystems.<span style="color:#bbb">newFileSystem</span>(uri,<span style="color:#666"> </span>Collections.<span style="color:#bbb">emptyMap</span>()))<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span><span style="color:#666">              </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span>findClassesInPath(fileSystem.<span style="color:#bbb">getPath</span>(path),<span style="color:#666"> </span>packageName);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span><span style="color:#666">          </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span><span style="color:#666">      </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span><span style="color:#666">      </span><span style="color:#999;font-style:italic">// We&#39;re running the injection code from an unpacked archive and can directly access the .class files.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span>findClassesInPath(Paths.<span style="color:#bbb">get</span>(uri),<span style="color:#666"> </span>packageName);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span><span style="color:#666">  </span>}</span></span></code></pre></div>
<p>Therefore, when looking for classes in <code>findClassesInPath</code>, we do not care
if we walk through the archived files of the .jar or are actually looking on
real files on our filesystem. Retrieving the actual class definitions
consists now of just</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// Iterate through all .class files in the given path for the given package.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">private</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">static</span><span style="color:#666"> </span>Set&lt;Class&lt;?&gt;&gt;<span style="color:#666"> </span>findClassesInPath(Path<span style="color:#666"> </span>path,<span style="color:#666"> </span>String<span style="color:#666"> </span>packageName)<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">throws</span><span style="color:#666"> </span>IOException<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">try</span><span style="color:#666"> </span>(<span style="color:#6ab825;font-weight:bold">var</span><span style="color:#666"> </span>walk<span style="color:#666"> </span>=<span style="color:#666"> </span>Files.<span style="color:#bbb">walk</span>(path,<span style="color:#666"> </span>1))<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span>walk<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span><span style="color:#666">                  </span>.<span style="color:#bbb">filter</span>(p<span style="color:#666"> </span>-&gt;<span style="color:#666"> </span>!Files.<span style="color:#bbb">isDirectory</span>(p))<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span><span style="color:#666">                  </span>.<span style="color:#bbb">filter</span>(p<span style="color:#666"> </span>-&gt;<span style="color:#666"> </span>p.<span style="color:#bbb">toString</span>().<span style="color:#bbb">endsWith</span>(<span style="color:#ed9d13">&#34;.class&#34;</span>))<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span><span style="color:#666">                  </span>.<span style="color:#bbb">map</span>(p<span style="color:#666"> </span>-&gt;<span style="color:#666"> </span>getClass(p,<span style="color:#666"> </span>packageName))<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span><span style="color:#666">                  </span>.<span style="color:#bbb">filter</span>(Objects::nonNull)<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span><span style="color:#666">                  </span>.<span style="color:#bbb">collect</span>(Collectors.<span style="color:#bbb">toSet</span>());<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span><span style="color:#666">      </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span><span style="color:#666">  </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// Retrieve a class based on the path and package name.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">private</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">static</span><span style="color:#666"> </span>Class&lt;?&gt;<span style="color:#666"> </span>getClass(Path<span style="color:#666"> </span>classPath,<span style="color:#666"> </span>String<span style="color:#666"> </span>packageName)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">try</span><span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span><span style="color:#666">          </span>String<span style="color:#666"> </span>className<span style="color:#666"> </span>=<span style="color:#666"> </span>packageName<span style="color:#666"> </span>+<span style="color:#666"> </span><span style="color:#ed9d13">&#34;.&#34;</span><span style="color:#666"> </span>+<span style="color:#666"> </span>classPath.<span style="color:#bbb">getFileName</span>().<span style="color:#bbb">toString</span>().<span style="color:#bbb">replace</span>(<span style="color:#ed9d13">&#34;.class&#34;</span>,<span style="color:#666"> </span><span style="color:#ed9d13">&#34;&#34;</span>);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span>Class.<span style="color:#bbb">forName</span>(className);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span><span style="color:#666">      </span>}<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">catch</span><span style="color:#666"> </span>(ClassNotFoundException<span style="color:#666"> </span>e)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">null</span>;<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span><span style="color:#666">      </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span><span style="color:#666">  </span>}</span></span></code></pre></div>
<p>I know that we do not recursively descend into subdirectories &ndash; good enough
for the example ;-).</p>
<p>Once we have a list of class definitions, we can finally instantiate them
and call component constructors with the instantiated classes. The dependency
resolution and object instantiation happens in
<code>createSingleton</code>. To simplify our implementation, we have a very basic
dependency resolution. This function is called recursively for all constructor
arguments to find singleton instances. If they are not yet available, we try
to construct them while resolving their dependencies as well. To keep track
of cycles, we keep track of already visited classes.</p>
<p>This could of course be done more clever for the price of blowing up the
number of lines of  code, hence, good enough for this demonstration.</p>






<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// Creates a new instance for the passed class using its constructor.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">///</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span><span style="color:#666">  </span><span style="color:#999;font-style:italic">/// We resolve all dependent constructor parameters.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span><span style="color:#666">  </span><span style="color:#6ab825;font-weight:bold">private</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">static</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">void</span><span style="color:#666"> </span><span style="color:#447fcf">createSingleton</span>(Map&lt;Class&lt;?&gt;,<span style="color:#666"> </span>Object&gt;<span style="color:#666"> </span>singletons,<span style="color:#666"> </span>Set&lt;Class&lt;?&gt;&gt;<span style="color:#666"> </span>visited,<span style="color:#666"> </span>Class&lt;?&gt;<span style="color:#666"> </span>clazz)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span><span style="color:#666">      </span><span style="color:#999;font-style:italic">// Cycle detection. We&#39;ve been called to resolve a parameter dependency, but already tried to resolve the</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span><span style="color:#666">      </span><span style="color:#999;font-style:italic">// dependencies for this class. When trying to resolve clazz&#39; dependencies, we will run into an infinite cycle.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">if</span><span style="color:#666"> </span>(!visited.<span style="color:#bbb">add</span>(clazz))<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">var</span><span style="color:#666"> </span>names<span style="color:#666"> </span>=<span style="color:#666"> </span>visited.<span style="color:#bbb">stream</span>().<span style="color:#bbb">map</span>(Class::getSimpleName).<span style="color:#bbb">collect</span>(Collectors.<span style="color:#bbb">joining</span>(<span style="color:#ed9d13">&#34;, &#34;</span>));<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">throw</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">new</span><span style="color:#666"> </span>IllegalStateException(<span style="color:#ed9d13">&#34;Cycle detected. Visited classes=&#34;</span><span style="color:#666"> </span>+<span style="color:#666"> </span>names);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span><span style="color:#666">      </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">var</span><span style="color:#666"> </span>cs<span style="color:#666"> </span>=<span style="color:#666"> </span>clazz.<span style="color:#bbb">getDeclaredConstructors</span>();<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">if</span><span style="color:#666"> </span>(cs.<span style="color:#bbb">length</span><span style="color:#666"> </span>&gt;<span style="color:#666"> </span>1)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">throw</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">new</span><span style="color:#666"> </span>IllegalArgumentException(<span style="color:#ed9d13">&#34;No unique constructor found for &#34;</span><span style="color:#666"> </span>+<span style="color:#666"> </span>clazz.<span style="color:#bbb">getSimpleName</span>());<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span><span style="color:#666">      </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">var</span><span style="color:#666"> </span>constructor<span style="color:#666"> </span>=<span style="color:#666"> </span>cs[0];<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">var</span><span style="color:#666"> </span>expectedInjections<span style="color:#666"> </span>=<span style="color:#666"> </span>constructor.<span style="color:#bbb">getParameterTypes</span>();<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span><span style="color:#666">      </span><span style="color:#999;font-style:italic">// For every dependent dependency, generate a new instance. Note that we implicitly handle the case for</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span><span style="color:#666">      </span><span style="color:#999;font-style:italic">// parameter-less constructors here as well.</span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span><span style="color:#666">      </span>Arrays.<span style="color:#bbb">stream</span>(expectedInjections).<span style="color:#bbb">forEach</span>(depClass<span style="color:#666"> </span>-&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span><span style="color:#666">          </span>createSingleton(singletons,<span style="color:#666"> </span>visited,<span style="color:#666"> </span>depClass);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span><span style="color:#666">      </span>});<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span><span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">var</span><span style="color:#666"> </span>params<span style="color:#666"> </span>=<span style="color:#666"> </span>Arrays.<span style="color:#bbb">stream</span>(expectedInjections).<span style="color:#bbb">map</span>(singletons::get).<span style="color:#bbb">toArray</span>();<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span><span><span style="color:#666">      </span><span style="color:#6ab825;font-weight:bold">try</span><span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span><span><span style="color:#666">          </span>singletons.<span style="color:#bbb">put</span>(clazz,<span style="color:#666"> </span>constructor.<span style="color:#bbb">newInstance</span>(params));<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28</span><span><span style="color:#666">      </span>}<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">catch</span><span style="color:#666"> </span>(InstantiationException<span style="color:#666"> </span>|<span style="color:#666"> </span>IllegalAccessException<span style="color:#666"> </span>|<span style="color:#666"> </span>InvocationTargetException<span style="color:#666"> </span>e)<span style="color:#666"> </span>{<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">29</span><span><span style="color:#666">          </span><span style="color:#6ab825;font-weight:bold">throw</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">new</span><span style="color:#666"> </span>IllegalStateException(<span style="color:#ed9d13">&#34;Unable to create instance for &#34;</span><span style="color:#666"> </span>+<span style="color:#666"> </span>clazz.<span style="color:#bbb">getSimpleName</span>(),<span style="color:#666"> </span>e);<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">30</span><span><span style="color:#666">      </span>}<span style="color:#666">
</span></span></span><span style="display:flex;"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">31</span><span><span style="color:#666">  </span>}</span></span></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>&hellip; and well, that&rsquo;s actually all you need to implement. As stated above,
it&rsquo;s far from complete or error-prone. The important thing, though, is:
dependency injection is not some magical thing that happens behind the
curtains of famous and advanced frameworks. Instead, it&rsquo;s something that <strong>you
could have invented yourself</strong>.</p>
<h2 id="source-code">Source code</h2>
<p>The whole source code can be found
on <a href="https://github.com/mlesniak/dependency-injection">GitHub</a>.</p>

  </content>
  <p>
    
  </p>

    </main>
    <footer>
      


    </footer>

    
</body>
</html>
