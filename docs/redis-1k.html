<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Redis in 1024 lines of code</title>
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<header>
		<div class="header-content">
			<a href="/"><img src="profile.png" alt="profile picture" height="32"></a>
			<a href="/" class="name">Michael Lesniak</a>
			<span class="right">
				<a href="/about.html">About me</a>
				<a href="mailto:mail@mlesniak.com">Email</a>
				<a href="https://github.com/mlesniak"> GitHub </a>
			</span>
		</div>
	</header>

	<article>
				<h1 class="title">Redis in 1024 lines of code</h1>
						<p>This article describes my approach to write a Redis clone in C#,
limiting myself to 1024 lines of code (as stated by the code analysis
tool <a href="https://github.com/AlDanial/cloc">cloc</a>). A similar
approach for various topics has been discussed in books such as <a
href="https://amzn.eu/d/b4iJBIa">500 Lines or Less</a>.</p>
<h2 id="the-goal">The goal</h2>
<p>The aim is to allow the official Redis CLI tool to interface with our
server and execute as many standard-compliant operations as possible. As
a twist in this experiment, I will be using a test-driven approach as
much as possible and will write the code in parallel to the blog post –
expect refactoring and questioning of design decisions in later stages
of the post…</p>
<h2 id="the-beginning">The beginning</h2>
<p>While I could have commenced by diving into the protocol
specification and building the server accordingly, I felt that might be
somewhat mundane. Instead, I opted to initiate a basic TCP server, set
it to listen on port 6379 (the standard port for Redis), and observe the
commands the client transmits.</p>
<p>After setting up a project with
<code>dotnet new console -o src</code>, let’s spawn up a simple TCP
server which simply output what it has received</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Program.cs</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> System<span class="op">.</span><span class="fu">Net</span><span class="op">.</span><span class="fu">Sockets</span><span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>TcpListener server <span class="op">=</span> <span class="kw">new</span><span class="op">(</span><span class="dv">6379</span><span class="op">);</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>server<span class="op">.</span><span class="fu">Start</span><span class="op">();</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;Server started&quot;</span><span class="op">);</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">while</span> <span class="op">(</span><span class="kw">true</span><span class="op">)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    TcpClient client <span class="op">=</span> server<span class="op">.</span><span class="fu">AcceptTcpClient</span><span class="op">();</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">(</span><span class="st">&quot;Client connected&quot;</span><span class="op">);</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> stream <span class="op">=</span> client<span class="op">.</span><span class="fu">GetStream</span><span class="op">();</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">byte</span><span class="op">[]</span> buffer <span class="op">=</span> <span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span><span class="dv">1024</span><span class="op">];</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> read <span class="op">=</span> stream<span class="op">.</span><span class="fu">Read</span><span class="op">(</span>buffer<span class="op">);</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">foreach</span> <span class="op">(</span><span class="dt">byte</span> b <span class="kw">in</span> buffer<span class="op">.</span><span class="fu">Take</span><span class="op">(</span>read<span class="op">))</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        Console<span class="op">.</span><span class="fu">Write</span><span class="op">((</span><span class="dt">char</span><span class="op">)</span>b<span class="op">);</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    Console<span class="op">.</span><span class="fu">WriteLine</span><span class="op">();</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    client<span class="op">.</span><span class="fu">Close</span><span class="op">();</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Subsequently, we’ll start the redis-cli through the default Docker
image:</p>
<pre><code>docker run --rm -it redis redis-cli -h docker.for.mac.localhost</code></pre>
<p>The printout from the TCP server reveals the incoming data:</p>
<pre><code>Server started
Client connected
*2
$7
COMMAND
$4
DOCS</code></pre>
<p>Revisiting the protocol specification, it becomes evident that the
client dispatches an array containing two components. Each of these is a
bulk string. Essentially, the client is requesting the server to furnish
a list of supported commands along with their respective
documentation.</p>
<h2 id="parsing-bulk-strings">Parsing bulk strings</h2>
<!-- setting up a test project -->
<p>I intentionally want to completely separate the actual implementation
for its corresponding tests. Therefore let’s setup a test project using
<a href="https://xunit.net/">xUnit</a> via
<code>dotnet new xunit -o test</code> in the parent directory of the
source code.</p>
<!-- test for bulk string -->
<p>The first test to verify correct parsing of bulk strings looks
like</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ToRedisMessage_SimpleBulkString_ReturnsCorrectResult</span><span class="op">()</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> message <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                  $<span class="dv">5</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                  HELLO</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;&quot;&quot;.ToRedisMessage();</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> data <span class="op">=</span> RedisData<span class="op">.</span><span class="fu">Parse</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span>RedisData<span class="op">.</span><span class="fu">RedisDataType</span><span class="op">.</span><span class="fu">BulkString</span><span class="op">,</span> data<span class="op">.</span><span class="fu">Type</span><span class="op">);</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span><span class="st">&quot;HELLO&quot;</span><span class="op">,</span> data<span class="op">.</span><span class="fu">BulkString</span><span class="op">);</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>As you can see by the test, a bulk string consists of a
<code>$</code> and a number stating the number of bytes to follow which
will build up the string. Implicitly stated, but hidden in the string
representation is the delimiter between elements,
i.e. <code>\r\n</code>.</p>
<!-- initial data structure -- will probably change -->
<p>To represent the received input, and generate corresponding output
later on, let’s start with a basic data structure which will probably be
changed a lot once we gain more insights.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> RedisData</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">enum</span> RedisDataType</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        Array<span class="op">,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        BulkString<span class="op">,</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> RedisDataType Type <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">string</span><span class="op">?</span> BulkString <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> List<span class="op">&lt;</span>RedisData<span class="op">&gt;?</span> ArrayValues <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="kw">set</span><span class="op">;</span> <span class="op">}</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> RedisData <span class="fu">Parse</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> data<span class="op">)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span>RedisData result<span class="op">,</span> _<span class="op">)</span> <span class="op">=</span> <span class="fu">Parse</span><span class="op">(</span>data<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> result<span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// return (parsed data, beginning of next element)</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="op">(</span>RedisData<span class="op">,</span> <span class="dt">int</span><span class="op">)</span> <span class="fu">Parse</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> data<span class="op">,</span> <span class="dt">int</span> offset<span class="op">)</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// </span><span class="al">TODO</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>Currently, only (nested) arrays and bulk strings will be supported by
our parsing routine <code>Parse()</code>. Internally, it calls its
counterpart which allows to specify the starting point for parsing which
is necessary for sequential structures such as arrays.</p>
<!-- implementation -- leave out arrays for now -->
<p>Ignoring parsing arrays for now – overall, we focus on a somewhat
test-driven approach and our tests focus on bulk strings for now – we
can parse bulk strings as follows:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">static</span> <span class="op">(</span>RedisData<span class="op">,</span> <span class="dt">int</span><span class="op">)</span> <span class="fu">Parse</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> data<span class="op">,</span> <span class="dt">int</span> offset<span class="op">)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    RedisData result <span class="op">=</span> <span class="kw">new</span><span class="op">();</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> end <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>data<span class="op">[</span>offset<span class="op">]</span> <span class="op">==</span> <span class="ch">&#39;*&#39;</span><span class="op">)</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">NotImplementedException</span><span class="op">();</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span>data<span class="op">[</span>offset<span class="op">]</span> <span class="op">==</span> <span class="ch">&#39;$&#39;</span><span class="op">)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span><span class="fu">Type</span> <span class="op">=</span> RedisDataType<span class="op">.</span><span class="fu">BulkString</span><span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> lengthEnd <span class="op">=</span> Array<span class="op">.</span><span class="fu">IndexOf</span><span class="op">(</span>data<span class="op">,</span> <span class="op">(</span><span class="dt">byte</span><span class="op">)</span><span class="ch">&#39;\r&#39;</span><span class="op">,</span> offset<span class="op">);</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> length <span class="op">=</span> Int32<span class="op">.</span><span class="fu">Parse</span><span class="op">(</span>Encoding<span class="op">.</span><span class="fu">ASCII</span><span class="op">.</span><span class="fu">GetString</span><span class="op">(</span>data<span class="op">,</span> offset <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> lengthEnd <span class="op">-</span> offset <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> stringStart <span class="op">=</span> lengthEnd <span class="op">+</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span><span class="fu">BulkString</span> <span class="op">=</span> Encoding<span class="op">.</span><span class="fu">ASCII</span><span class="op">.</span><span class="fu">GetString</span><span class="op">(</span>data<span class="op">,</span> stringStart<span class="op">,</span> length<span class="op">);</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        nextOffset <span class="op">=</span> stringStart <span class="op">+</span> length <span class="op">+</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">else</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">ArgumentException</span><span class="op">(</span>$<span class="st">&quot;Invalid byte {data[offset]} to parse&quot;</span><span class="op">);</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="op">(</span>result<span class="op">,</span> end<span class="op">);</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note that the internal implementation will be refactored once our
basic test cases are working.</p>
<h2 id="parsing-arrays">Parsing arrays</h2>
<p>We can use a similar approach to parse arrays, though arrayc are
recursive data structures in the redis protocol and can contain both
plain values, e.g. bulk strings, as nested arrays. Hence, let’s define
two different test cases: The first one mirrors the data we receive from
the client and will allow to parse sent commands, the second checks that
the implementation handles nested arrays correctly:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ToRedisMessage_SimpleArray_ReturnsCorrectResult</span><span class="op">()</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> message <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                    <span class="op">*</span><span class="dv">2</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                    $<span class="dv">5</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                    HELLO</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                    $<span class="dv">3</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                    FOO</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;&quot;&quot;.ToRedisMessage();</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> data <span class="op">=</span> RedisData<span class="op">.</span><span class="fu">Parse</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span>RedisData<span class="op">.</span><span class="fu">RedisDataType</span><span class="op">.</span><span class="fu">Array</span><span class="op">,</span> data<span class="op">.</span><span class="fu">Type</span><span class="op">);</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span>RedisData<span class="op">.</span><span class="fu">RedisDataType</span><span class="op">.</span><span class="fu">BulkString</span><span class="op">,</span> data<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">![</span><span class="dv">0</span><span class="op">].</span><span class="fu">Type</span><span class="op">);</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span><span class="st">&quot;HELLO&quot;</span><span class="op">,</span> data<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">![</span><span class="dv">0</span><span class="op">].</span><span class="fu">BulkString</span><span class="op">);</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span>RedisData<span class="op">.</span><span class="fu">RedisDataType</span><span class="op">.</span><span class="fu">BulkString</span><span class="op">,</span> data<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">![</span><span class="dv">1</span><span class="op">].</span><span class="fu">Type</span><span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span><span class="st">&quot;FOO&quot;</span><span class="op">,</span> data<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">![</span><span class="dv">1</span><span class="op">].</span><span class="fu">BulkString</span><span class="op">);</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="op">[</span>Fact<span class="op">]</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ToRedisMessage_NestedArray_ReturnsCorrectResult</span><span class="op">()</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> message <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>                    <span class="op">*</span><span class="dv">2</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>                    <span class="op">*</span><span class="dv">2</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>                    $<span class="dv">3</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>                    BAR</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>                    $<span class="dv">5</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>                    HELLO</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                    $<span class="dv">3</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>                    FOO</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;&quot;&quot;.ToRedisMessage();</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> data <span class="op">=</span> RedisData<span class="op">.</span><span class="fu">Parse</span><span class="op">(</span>message<span class="op">);</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span>RedisData<span class="op">.</span><span class="fu">RedisDataType</span><span class="op">.</span><span class="fu">Array</span><span class="op">,</span> data<span class="op">.</span><span class="fu">Type</span><span class="op">);</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span>RedisData<span class="op">.</span><span class="fu">RedisDataType</span><span class="op">.</span><span class="fu">Array</span><span class="op">,</span> data<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">![</span><span class="dv">0</span><span class="op">].</span><span class="fu">Type</span><span class="op">);</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="dt">var</span> array <span class="op">=</span> data<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">![</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span><span class="st">&quot;BAR&quot;</span><span class="op">,</span> array<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">?[</span><span class="dv">0</span><span class="op">].</span><span class="fu">BulkString</span><span class="op">);</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span><span class="st">&quot;HELLO&quot;</span><span class="op">,</span> array<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">?[</span><span class="dv">1</span><span class="op">].</span><span class="fu">BulkString</span><span class="op">);</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span>RedisData<span class="op">.</span><span class="fu">RedisDataType</span><span class="op">.</span><span class="fu">BulkString</span><span class="op">,</span> data<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">![</span><span class="dv">1</span><span class="op">].</span><span class="fu">Type</span><span class="op">);</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Equal</span><span class="op">(</span><span class="st">&quot;FOO&quot;</span><span class="op">,</span> data<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">?[</span><span class="dv">1</span><span class="op">].</span><span class="fu">BulkString</span><span class="op">);</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This can be implemented via the following snippet inside
<code>Parse()</code></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">(</span>data<span class="op">[</span>offset<span class="op">]</span> <span class="op">==</span> <span class="ch">&#39;*&#39;</span><span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span><span class="fu">Type</span> <span class="op">=</span> RedisDataType<span class="op">.</span><span class="fu">Array</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span><span class="fu">ArrayValues</span> <span class="op">=</span> <span class="kw">new</span><span class="op">();</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> numElementsIndexEnd <span class="op">=</span> Array<span class="op">.</span><span class="fu">IndexOf</span><span class="op">(</span>data<span class="op">,</span> <span class="op">(</span><span class="dt">byte</span><span class="op">)</span><span class="ch">&#39;\r&#39;</span><span class="op">,</span> offset<span class="op">);</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> numElements <span class="op">=</span> Int32<span class="op">.</span><span class="fu">Parse</span><span class="op">(</span>Encoding<span class="op">.</span><span class="fu">ASCII</span><span class="op">.</span><span class="fu">GetString</span><span class="op">(</span>data<span class="op">,</span> offset <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> numElementsIndexEnd <span class="op">-</span> offset <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        offset <span class="op">=</span> numElementsIndexEnd <span class="op">+</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> <span class="op">(</span><span class="dt">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> numElements<span class="op">;</span> i<span class="op">++)</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>            <span class="op">(</span>RedisData elem<span class="op">,</span> <span class="dt">int</span> nextArrayOffset<span class="op">)</span> <span class="op">=</span> <span class="fu">Parse</span><span class="op">(</span>data<span class="op">,</span> offset<span class="op">);</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            result<span class="op">.</span><span class="fu">ArrayValues</span><span class="op">.</span><span class="fu">Add</span><span class="op">(</span>elem<span class="op">);</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>            offset <span class="op">=</span> nextArrayOffset<span class="op">;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        nextOffset <span class="op">=</span> offset<span class="op">;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>Since we now have a basic test setup, let’s refactor the code a bit
by moving away from this <code>if-else</code> cascade and introduce a
switch statement and move the type-defining character to the enum.</p>
<h3 id="a-short-excursion-into-over-engineering">A short excursion into
over-engineering</h3>
<p>We want to implement a more general approach the if-else-cascade,
though one can rightfully argue that this is not the worst code to
maintain. Nonetheless, a <code>switch</code> statement would be possible
as well. For that, we have to add a custom attribute which stores the
corresponding encoding character for each data type:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cs"><code class="sourceCode cs"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">[</span><span class="fu">AttributeUsage</span><span class="op">(</span>AttributeTargets<span class="op">.</span><span class="fu">Field</span><span class="op">)]</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">sealed</span> <span class="kw">class</span> ByteRepresentationAttribute <span class="op">:</span> Attribute</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">byte</span> Byte <span class="op">{</span> <span class="kw">get</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="fu">ByteRepresentationAttribute</span><span class="op">(</span><span class="dt">char</span> b<span class="op">)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        Byte <span class="op">=</span> <span class="op">(</span><span class="dt">byte</span><span class="op">)</span>b<span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This allows to annotate the data type definition via</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode cs"><code class="sourceCode cs"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">enum</span> RedisDataType</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">ByteRepresentation</span><span class="op">(</span><span class="ch">&#39;*&#39;</span><span class="op">)]</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    Array<span class="op">,</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">[</span><span class="fu">ByteRepresentation</span><span class="op">(</span><span class="ch">&#39;$&#39;</span><span class="op">)]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    BulkString<span class="op">,</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>and retrieve the corresponding field from the type via an extension
function</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode cs"><code class="sourceCode cs"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">static</span> <span class="kw">class</span> DataTypeIdentifier</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="kw">static</span> <span class="dt">byte</span> <span class="fu">Identifier</span><span class="op">(</span><span class="kw">this</span> RedisDataType type<span class="op">)</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> fieldInfo <span class="op">=</span> type<span class="op">.</span><span class="fu">GetType</span><span class="op">().</span><span class="fu">GetField</span><span class="op">(</span>type<span class="op">.</span><span class="fu">ToString</span><span class="op">())!;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">var</span> attribute <span class="op">=</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>            <span class="op">((</span>ByteRepresentationAttribute<span class="op">)</span>fieldInfo<span class="op">.</span><span class="fu">GetCustomAttribute</span><span class="op">(</span><span class="kw">typeof</span><span class="op">(</span>ByteRepresentationAttribute<span class="op">))!);</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> attribute<span class="op">.</span><span class="fu">Byte</span><span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This looks – on the first look – like a nice solution and we can
refactor the <code>if</code>s into a switch statement</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode cs"><code class="sourceCode cs"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">switch</span> <span class="op">(</span>data<span class="op">[</span>offset<span class="op">])</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="dt">var</span> b when b <span class="op">==</span> RedisDataType<span class="op">.</span><span class="fu">BulkString</span><span class="op">.</span><span class="fu">Identifier</span><span class="op">():</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">break</span><span class="op">;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="dt">var</span> b when b <span class="op">==</span> RedisDataType<span class="op">.</span><span class="fu">Array</span><span class="op">.</span><span class="fu">Identifier</span><span class="op">():</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">break</span><span class="op">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">default</span><span class="op">:</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">ArgumentException</span><span class="op">(</span>$<span class="st">&quot;Invalid byte {data[offset]} to parse&quot;</span><span class="op">);</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>where the problem becomes (in my humble view) obvious: while the
switch looks syntactically simpler, the necessary
<code>var b when b == ...</code> construct does not look very nice and
quite a bit convoluted.</p>
	</article>
</body>

</html>
